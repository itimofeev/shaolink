# Shaolink

Это проект служит, как способ разобраться, как реализовать шардинг с помощью go + postgres.

Термины разнятся, но идею передают.

### Партиционирование
Разделение большой таблицы на куски поменьше. Например, по месяцам, если мы знаем, что обращение к последнему месяцу происходит гораздо чаще остальных.
Обычно эти куски хранятся на одной машине. Это делается, для ускорения доступа к данным, т.к. самих данных в одной партиции меньше, чем во всей таблице. + управлять легче, например, можно дропнуть всю партицию, если она уже не нужна.
В свежих постгресах это можно реализовать декларативно.

### Шардирование (горизонтальное)
Аналогично, разбиение большого количества данных на кучки, в основном с целью балансировки нагрузки, т.к. шарды можно вынести на отдельные машины.

# Пример шардирования
на go + postgres на основе сервиса для сокращения ссылок

Есть таблица shortens. Мы предполагаем, что она может быть очень большая, и на неё будет большая нагрузка.
Для примера пусть будет 10 виртуальных шардов. В каждом шарде создадим таблицу `shortens`. Виртуальный шард -- схема в БД Postgres (shard0, ..., shard9). Схему можно вынести на другой сервер и подключить в основной через `IMPORT FOREIGN SCHEMA`. С точки зрения клиентского кода, работа будет как с локальной схемой.

Количество шардов и способ определения записи в шард выбраны для тестового примера, в зависимости от реальной задачи скорее всего нужно будет выбрать другой алгоритм.

Перед вставкой очередной записи в БД, мы случайным образом выбираем шард (0..9) и случайную строку из 62 символов (латинский алфавит x2 + 10 цифр). Вставка происходит в соответствующий шард/схему.
Получение объекта по ключу происходит аналогичным образом. Из ключа достаём номер шарда, и уже в нём ищем нужный объект.

# Как поиграться
- должны быть установлены docker, make 
- `make run-db`, запустит контейнер с постгресом на 5432 порту с именем db
- `go test github.com/itimofeev/shaolink/internal/pg -test.v`
- в логах тестов будет строчка distribution, показывающая распределение количества записей по шардам (например, `distribution of records by shard number map[0:430 1:520 2:406 3:467 4:353 5:369 6:421 7:423 8:436 9:510]`)
